<div class="ticket-list-page">
  <!-- Breadcrumb -->
  <div class="breadcrumb-container">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a routerLink="/tickets">{{ t('tickets.allTickets') }}</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ t('tickets.allTickets') }}</li>
      </ol>
    </nav>
  </div>

  <!-- Status Loading Indicator -->
  <div *ngIf="isLoadingStatuses" class="status-loading mb-3">
    <div class="alert alert-info" role="alert">
      <span class="spinner-border spinner-border-sm me-2"></span>
      {{ t('tickets.loadingStatus') }}
    </div>
  </div>

  <!-- Status Error Indicator -->
  <div *ngIf="statusError && !isLoadingStatuses" class="status-error mb-3">
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ statusError }}
      <button type="button" class="btn btn-sm btn-outline-warning ms-2" (click)="reloadStatusCache()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        {{ t('tickets.reload') }}
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">

    <!-- Priority Filter -->
    <div class="filter-item priority-item">
      <label class="filter-label">{{ t('tickets.priority') }}</label>
      <select class="filter-select" [(ngModel)]="selectedPriority" (ngModelChange)="onPriorityChangeModel($event)">
        <option value="">{{ t('tickets.allPriority') }}</option>
        <option value="3">{{ t('tickets.priorityHigh') }}</option>
        <option value="2">{{ t('tickets.priorityMedium') }}</option>
        <option value="1">{{ t('tickets.priorityLow') }}</option>
      </select>
    </div>

    <!-- Status Filter -->
    <div class="filter-item status-item">
      <label class="filter-label">{{ t('tickets.status') }}</label>
      <select class="filter-select" [(ngModel)]="selectedStatus" (ngModelChange)="onStatusChangeModel($event)">
        <option value="">{{ t('tickets.allStatus') }}</option>
        <option value="1">{{ t('tickets.pending') }}</option>
        <option value="2">{{ t('tickets.openTicket') }}</option>
        <option value="3">{{ t('tickets.inProgress') }}</option>
        <option value="4">{{ t('tickets.resolved') }}</option>
        <option value="5">{{ t('tickets.complete') }}</option>
        <option value="6">{{ t('tickets.cancel') }}</option>
      </select>
    </div>

    <!-- Categories Filter -->
    <div class="filter-item category-item">
      <label class="filter-label">{{ t('tickets.categories') }}</label>
      <select class="filter-select" [(ngModel)]="selectedCategory" (ngModelChange)="onCategoryChangeModel($event)">
        <option value="">{{ t('tickets.allCategories') }}</option>
        <option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</option>
      </select>
    </div>

    <!-- Project Filter -->
    <div class="filter-item project-item">
      <label class="filter-label">{{ t('tickets.projectName') }}</label>
      <select class="filter-select" [(ngModel)]="selectedProject" (ngModelChange)="onProjectChangeModel($event)">
        <option value="">{{ t('tickets.allProjects') }}</option>
        <option *ngFor="let p of projects" [value]="p.id">{{ p.name }}</option>
      </select>
    </div>

    <!-- Search -->
    <div class="filter-item search-item">
      <label class="filter-label">{{ t('tickets.search') }}</label>
      <div class="search-input-wrapper search-with-button">
        <i class="bi bi-search search-icon"></i>

        <!-- Input -->
        <input type="text" class="search-input" [placeholder]="t('tickets.searchPlaceholder')" [(ngModel)]="searchText"
          (keyup.enter)="applyFilters()" />

        <!-- Clear -->
        <button type="button" class="clear-search-btn" *ngIf="searchText && searchText.trim()" (click)="clearSearch()"
          [title]="t('common.clear')">
          <i class="bi bi-x-circle-fill"></i>
        </button>

        <!-- Search button -->
        <button type="button" class="btn search-btn-modern" (click)="applyFilters()" [title]="t('tickets.search')">
          <i class="bi bi-search me-1"></i> {{ t('tickets.search') }}
        </button>
      </div>
    </div>

    <!-- Export Button -->
    <div class="filter-item export-item">
      <label class="filter-label">&nbsp;</label>
      <button type="button" class="btn btn-success export-btn" (click)="exportExcel()">
        <i class="bi bi-file-earmark-excel"></i> {{ t('tickets.exportExcel') }}
      </button>
    </div>
  </div>

  <!-- Filter Loading State -->
  <div *ngIf="loadingFilters" class="filter-loading">
    <div class="loading-message">
      <span class="spinner-border spinner-border-sm me-2"></span>
      {{ t('tickets.loadingFilters') }}
    </div>
  </div>

  <!-- Filter Error State -->
  <div *ngIf="filterError && !loadingFilters" class="filter-error">
    <div class="alert alert-warning" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ filterError }}
      <button type="button" class="btn btn-sm btn-outline-warning ms-2" (click)="loadMasterFilters()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        {{ t('tickets.tryAgain') }}
      </button>
    </div>
  </div>

  <!-- Tickets Error State -->
  <div *ngIf="ticketsError && !isLoading" class="tickets-error">
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>{{ t('common.error') }}:</strong> {{ ticketsError }}
      <button type="button" class="btn btn-sm btn-outline-danger ms-2" (click)="reloadTickets()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        {{ t('tickets.tryAgain') }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="static-loading-indicator">
      <div class="loading-spinner"></div>
      <p class="static-loading-text">{{ t('tickets.loadingTickets') }}</p>
    </div>
  </div>

  <!-- No Tickets Found -->
  <div *ngIf="!isLoading && noTicketsFound && !ticketsError" class="no-tickets-found">
    <div class="no-results-content">
      <i class="bi bi-inbox no-results-icon"></i>
      <h3>{{ t('tickets.noTicketsFound') }}</h3>
      <p>{{ t('tickets.noTicketsSystem') }}</p>
      <button class="btn btn-primary" (click)="createNewTicket()" *ngIf="canCreateTickets">
        <i class="bi bi-plus me-2"></i>
        {{ t('tickets.createTicket') }}
      </button>
    </div>
  </div>

  <!-- Tickets List -->
  <div *ngIf="!isLoading && !noTicketsFound" class="tickets-container">
    <!-- No Results from Filter -->
    <div *ngIf="filteredTickets.length === 0 && tickets.length > 0" class="no-results">
      <div class="no-results-content">
        <i class="bi bi-search no-results-icon"></i>
        <h3>{{ t('tickets.noResultsFilter') }}</h3>
        <p>{{ t('tickets.adjustSearchCriteria') }}</p>
        <button class="btn btn-primary" (click)="clearFilters()">
          <i class="bi bi-funnel me-2"></i>
          {{ t('tickets.clearFilters') }}
        </button>
      </div>
    </div>

    <!-- Tickets Grid -->
    <div *ngIf="filteredTickets.length > 0" class="tickets-grid">
      <div *ngFor="let ticket of filteredTickets" class="ticket-card" (click)="viewTicket(ticket)">

        <!-- Ticket Header -->
        <div class="ticket-header">
          <div class="ticket-header-left">
            <div class="ticket-info">
              <span class="ticket-id">{{ ticket.ticket_no }}</span>
              <div class="ticket-divider"></div>
              <span class="ticket-category">{{ ticket.categories_name }}</span>
              <div class="ticket-divider" *ngIf="isHighPriority(ticket)"></div>
              <div class="priority-warning" *ngIf="isHighPriority(ticket)">
                <i class="bi bi-exclamation-triangle-fill priority-icon"></i>
                <div class="priority-tooltip">
                  <span class="priority-tooltip-text">{{ t('tickets.priority') }}: {{ t('tickets.priorityHigh') }}</span>
                  <div class="priority-tooltip-arrow"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="ticket-header-right">
            <div class="ticket-date-status">
              <span class="ticket-date">{{ formatDate(ticket.create_date) }}</span>
              <div class="ticket-divider"></div>

              <!-- Status Badge -->
              <div class="status-badge" [ngClass]="getStatusBadgeClass(ticket.status_id)">
                <i class="bi bi-exclamation-triangle text-warning me-1" *ngIf="!statusCacheLoaded && !isLoadingStatuses"
                  [title]="t('tickets.statusFromDefault')"></i>

                <i class="status-icon" [ngClass]="getStatusIcon(ticket.status_id)"></i>
                <span class="status-text">{{ getStatusText(ticket.status_id) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Ticket Divider -->
        <div class="ticket-content-divider"></div>

        <!-- Ticket Content -->
        <div class="ticket-content">
          <div class="ticket-avatar">
            <div class="avatar-circle">
              <i class="bi bi-chat-dots-fill"></i>
            </div>
          </div>

          <div class="ticket-details">
            <div class="ticket-project-user">
              <h3 class="project-title">{{ ticket.project_name || 'Unknown Project' }}</h3>
              <div class="user-info">
                <i class="bi bi-person user-icon"></i>
                <span class="user-name">{{ getUserDisplayName(ticket) }}</span>
              </div>
            </div>
            <p class="ticket-description">{{ ticket.issue_description }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div *ngIf="filteredTickets.length > 0" class="results-summary">
      <p>
        {{ t('tickets.showing') }} {{ filteredTickets.length }} {{ t('tickets.of') }} {{ tickets.length }} {{ t('dashboard.tickets') }}
        <span *ngIf="ticketsError" class="text-warning ms-2">
          <i class="bi bi-exclamation-triangle"></i>
          ({{ t('tickets.usingCachedData') }})
        </span>
        <span *ngIf="!statusCacheLoaded && !isLoadingStatuses" class="text-muted ms-2">
          <i class="bi bi-info-circle"></i>
          ({{ t('tickets.statusFromDefault') }})
        </span>
      </p>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="pagination.totalPages > 1">
      <nav aria-label="Ticket pagination">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="pagination.currentPage === 1">
            <button class="page-link" (click)="changePage(pagination.currentPage - 1)">‹</button>
          </li>

          <li *ngFor="let p of getDisplayedPages()" class="page-item" [class.active]="p === pagination.currentPage"
            [class.disabled]="p === '...'">
            <button class="page-link" *ngIf="p !== '...'" (click)="changePage(+p)">{{ p }}</button>
            <span class="page-link" *ngIf="p === '...'">...</span>
          </li>

          <li class="page-item" [class.disabled]="pagination.currentPage === pagination.totalPages">
            <button class="page-link" (click)="changePage(pagination.currentPage + 1)">›</button>
          </li>
        </ul>
      </nav>

      <p class="pagination-info text-center mt-2">
        {{ t('tickets.foundData', {count: pagination.totalRows}) }}
        {{ t('tickets.displayingPage', {current: pagination.currentPage, total: pagination.totalPages}) }}
      </p>
    </div>

  </div>

  <!-- Floating Action Button -->
  <button class="fab-button" (click)="createNewTicket()" [title]="t('tickets.createTicket')" *ngIf="canCreateTickets">
    <i class="bi bi-plus"></i>
  </button>
</div>