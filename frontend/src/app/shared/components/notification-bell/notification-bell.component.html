<!-- src/app/shared/components/notification-bell/notification-bell.component.html -->
<!-- ✅ IMPROVED VERSION - Better Error Display -->

<!-- ✅ Notification Bell Container -->
<div class="notification-bell-container me-2" *ngIf="canViewNotifications()">
  
  <!-- ✅ Bell Button -->
  <button 
    class="btn-notification-bell" 
    type="button"
    (click)="toggleDropdown()"
    [class.has-unread]="hasUnreadNotifications()"
    [attr.aria-label]="getText('Notifications', 'การแจ้งเตือน')"
    [attr.aria-expanded]="isDropdownOpen">
    
    <!-- Bell Icon -->
    <i class="bi bi-bell" [class.bell-ring]="hasUnreadNotifications()"></i>
    
    <!-- Unread Badge -->
    <span 
      *ngIf="hasUnreadNotifications()" 
      class="notification-badge"
      [attr.aria-label]="getText(`${unreadCount} unread notifications`, `${unreadCount} การแจ้งเตือนที่ยังไม่ได้อ่าน`)">
      {{ unreadCount > 99 ? '99+' : unreadCount }}
    </span>
  </button>

  <!-- ✅ Dropdown Menu -->
  <div 
    class="notification-dropdown" 
    [class.show]="isDropdownOpen"
    (click)="onDropdownClick($event)">
    
    <!-- Header -->
    <div class="notification-header">
      <div class="header-left">
        <h6 class="header-title">
          <i class="bi bi-bell-fill me-2"></i>
          {{ getText('Notifications', 'การแจ้งเตือน') }}
        </h6>
        <span class="notification-count-text" *ngIf="summary">
          {{ summary.unread }} {{ getText('unread', 'ยังไม่ได้อ่าน') }}
        </span>
        
        <!-- ✅ NEW: Connection Status Indicator -->
        <span class="connection-status" 
              [class.connected]="isSocketConnected()"
              [class.connecting]="isSocketConnecting()"
              [class.disconnected]="!isSocketConnected() && !isSocketConnecting()">
          <i class="bi" 
             [class.bi-circle-fill]="isSocketConnected()"
             [class.bi-arrow-repeat]="isSocketConnecting()"
             [class.bi-exclamation-circle]="!isSocketConnected() && !isSocketConnecting()"></i>
          {{ getConnectionStatusText() }}
        </span>
      </div>
      
      <div class="header-right">
        <!-- Refresh Button -->
        <button 
          class="btn-icon-small" 
          (click)="refreshNotifications()"
          [disabled]="isLoading"
          [attr.aria-label]="getText('Refresh', 'รีเฟรช')">
          <i class="bi" 
             [class.bi-arrow-clockwise]="!isLoading" 
             [class.bi-hourglass-split]="isLoading"
             [class.spin-animation]="isLoading"></i>
        </button>

        <!-- Settings Button -->
        <button 
          class="btn-icon-small" 
          (click)="openNotificationSettings($event)"
          [attr.aria-label]="getText('Settings', 'ตั้งค่า')">
          <i class="bi bi-gear"></i>
        </button>

        <!-- Mark All as Read Button -->
        <button 
          class="btn-icon-small" 
          (click)="markAllAsRead($event)"
          *ngIf="hasUnreadNotifications()"
          [attr.aria-label]="getText('Mark all as read', 'อ่านทั้งหมด')">
          <i class="bi bi-check-all"></i>
        </button>
      </div>
    </div>

    <!-- ✅ Filter Tabs -->
    <div class="notification-filters">
      <button 
        class="filter-tab"
        [class.active]="selectedFilter === 'all'"
        (click)="changeFilter('all')">
        {{ getText('All', 'ทั้งหมด') }}
        <span class="filter-count" *ngIf="summary">{{ summary.total }}</span>
      </button>

      <button 
        class="filter-tab"
        [class.active]="selectedFilter === 'unread'"
        (click)="changeFilter('unread')">
        {{ getText('Unread', 'ยังไม่ได้อ่าน') }}
        <span class="filter-count" *ngIf="summary">{{ summary.unread }}</span>
      </button>

      <button 
        class="filter-tab"
        [class.active]="selectedFilter === 'today'"
        (click)="changeFilter('today')">
        {{ getText('Today', 'วันนี้') }}
        <span class="filter-count" *ngIf="summary">{{ summary.today }}</span>
      </button>
    </div>

    <!-- ✅ Type Filter Dropdown -->
    <div class="notification-type-filter" *ngIf="hasNotifications()">
      <select 
        class="form-select form-select-sm"
        [(ngModel)]="selectedType"
        (change)="changeTypeFilter(selectedType)">
        <option value="all">{{ getText('All Types', 'ทุกประเภท') }}</option>
        <option [value]="NotificationType.NEW_TICKET">
          {{ getNotificationTypeLabel(NotificationType.NEW_TICKET) }}
        </option>
        <option [value]="NotificationType.STATUS_CHANGE">
          {{ getNotificationTypeLabel(NotificationType.STATUS_CHANGE) }}
        </option>
        <option [value]="NotificationType.ASSIGNMENT">
          {{ getNotificationTypeLabel(NotificationType.ASSIGNMENT) }}
        </option>
        <option [value]="NotificationType.COMMENT">
          {{ getNotificationTypeLabel(NotificationType.COMMENT) }}
        </option>
        <option [value]="NotificationType.MENTION">
          {{ getNotificationTypeLabel(NotificationType.MENTION) }}
        </option>
      </select>
    </div>

    <!-- ✅ Loading State -->
    <div class="notification-loading" *ngIf="isLoading">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">{{ getText('Loading...', 'กำลังโหลด...') }}</span>
      </div>
      <span class="ms-2">{{ getText('Loading notifications...', 'กำลังโหลดการแจ้งเตือน...') }}</span>
    </div>

    <!-- ✅ IMPROVED: Error State with Retry Button -->
    <div class="notification-error" *ngIf="errorMessage && !isLoading">
      <i class="bi bi-exclamation-triangle-fill text-warning"></i>
      <span class="error-message">{{ errorMessage }}</span>
      
      <!-- ✅ NEW: Connection Status Message -->
      <span class="error-sub-message" *ngIf="!isSocketConnected()">
        {{ getText('Trying to reconnect...', 'กำลังพยายามเชื่อมต่อใหม่...') }}
      </span>
      
      <div class="error-actions">
        <button class="btn btn-sm btn-outline-primary" (click)="refreshNotifications()">
          <i class="bi bi-arrow-clockwise"></i>
          {{ getText('Retry', 'ลองใหม่') }}
        </button>
      </div>
    </div>

    <!-- ✅ Notification List -->
    <div class="notification-list" *ngIf="!isLoading && !errorMessage">
      
      <!-- Empty State -->
      <div class="notification-empty" *ngIf="getFilteredNotifications().length === 0">
        <i class="bi bi-bell-slash empty-icon"></i>
        <p class="empty-text">
          {{ getText('No notifications', 'ไม่มีการแจ้งเตือน') }}
        </p>
        <p class="empty-subtext">
          {{ getText('You\'re all caught up!', 'คุณอ่านครบทุกรายการแล้ว!') }}
        </p>
      </div>

      <!-- Notification Items -->
      <div 
        *ngFor="let notification of getFilteredNotifications(); trackBy: trackByNotificationId"
        class="notification-item"
        [class.unread]="notification.status === NotificationStatus.UNREAD"
        [class.high-priority]="notification.priority === NotificationPriority.HIGH || notification.priority === NotificationPriority.URGENT"
        (click)="onNotificationClick(notification, $event)">
        
        <!-- Icon -->
        <div class="notification-icon" [style.background-color]="notification.color">
          <i class="bi" [ngClass]="notification.icon"></i>
        </div>

        <!-- Content -->
        <div class="notification-content">
          <!-- Title Row -->
          <div class="notification-title-row">
            <h6 class="notification-title">{{ notification.title }}</h6>
            
            <!-- Priority Badge (for high/urgent only) -->
            <span 
              *ngIf="notification.priority === NotificationPriority.HIGH || notification.priority === NotificationPriority.URGENT"
              class="badge badge-sm"
              [ngClass]="getPriorityBadgeClass(notification.priority)">
              {{ getNotificationPriorityLabel(notification.priority) }}
            </span>
          </div>

          <!-- Message -->
          <p class="notification-message">{{ truncateText(notification.message, 80) }}</p>

          <!-- Meta Info -->
          <div class="notification-meta">
            <span class="meta-item">
              <i class="bi bi-clock"></i>
              {{ notification.timeAgo }}
            </span>
            <span class="meta-item">
              <i class="bi bi-tag"></i>
              {{ notification.ticket_no }}
            </span>
            <span class="meta-item meta-type">
              {{ getNotificationTypeLabel(notification.notification_type) }}
            </span>
          </div>
        </div>

        <!-- Actions -->
        <div class="notification-actions">
          <!-- Mark as Read Button -->
          <button 
            *ngIf="notification.status === NotificationStatus.UNREAD"
            class="btn-icon-tiny"
            (click)="markAsRead(notification, $event)"
            [attr.aria-label]="getText('Mark as read', 'ทำเครื่องหมายว่าอ่านแล้ว')">
            <i class="bi bi-check"></i>
          </button>

          <!-- Delete Button -->
          <button 
            class="btn-icon-tiny btn-delete"
            (click)="deleteNotification(notification, $event)"
            [attr.aria-label]="getText('Delete', 'ลบ')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ✅ Footer -->
    <div class="notification-footer" *ngIf="hasNotifications() && !isLoading">
      <!-- View All Button -->
      <button 
        class="btn btn-link btn-sm w-100"
        (click)="viewAllNotifications($event)">
        {{ getText('View All Notifications', 'ดูการแจ้งเตือนทั้งหมด') }}
        <i class="bi bi-arrow-right ms-1"></i>
      </button>

      <!-- Clear All Button -->
      <button 
        class="btn btn-link btn-sm text-danger w-100"
        (click)="deleteAllNotifications($event)"
        *ngIf="hasNotifications()">
        <i class="bi bi-trash"></i>
        {{ getText('Clear All', 'ลบทั้งหมด') }}
      </button>
    </div>

  </div>

  <!-- ✅ Backdrop -->
  <div 
    class="notification-backdrop"
    [class.show]="isDropdownOpen"
    (click)="closeDropdown()">
  </div>
</div>