<div class="notification-bell-container me-2" *ngIf="canViewNotifications()">
  
  <button 
    class="btn-notification-bell" 
    type="button"
    (click)="toggleDropdown()"
    [class.has-unread]="hasUnreadNotifications()"
    [attr.aria-label]="getText('Notifications', 'การแจ้งเตือน')"
    [attr.aria-expanded]="isDropdownOpen">
    
    <i class="bi bi-bell" [class.bell-ring]="hasUnreadNotifications()"></i>
    
    <span *ngIf="hasUnreadNotifications()" class="notification-badge">
      {{ unreadCount > 99 ? '99+' : unreadCount }}
    </span>
  </button>

  <div class="notification-dropdown" [class.show]="isDropdownOpen" (click)="onDropdownClick($event)">
    
    <div class="notification-header">
      <div class="header-left">
        <h6 class="header-title">
          <i class="bi bi-bell-fill me-2"></i>
          {{ getText('Notifications', 'การแจ้งเตือน') }}
        </h6>
        <span class="notification-count-text" *ngIf="summary">
          {{ summary.unread }} {{ getText('unread', 'ยังไม่ได้อ่าน') }}
        </span>
      </div>
      
      <div class="header-right">
        <button class="btn-icon-small" (click)="refreshNotifications()" [disabled]="isLoading">
          <i class="bi" [class.bi-arrow-clockwise]="!isLoading" [class.bi-hourglass-split]="isLoading" [class.spin-animation]="isLoading"></i>
        </button>

        <button class="btn-icon-small" (click)="openNotificationSettings($event)">
          <i class="bi bi-gear"></i>
        </button>

        <button class="btn-icon-small" (click)="markAllAsRead($event)" *ngIf="hasUnreadNotifications()">
          <i class="bi bi-check-all"></i>
        </button>
      </div>
    </div>

    <div class="notification-filters">
      <button class="filter-tab" [class.active]="selectedFilter === 'all'" (click)="changeFilter('all')">
        {{ getText('All', 'ทั้งหมด') }} <span class="filter-count" *ngIf="summary">{{ summary.total }}</span>
      </button>
      <button class="filter-tab" [class.active]="selectedFilter === 'unread'" (click)="changeFilter('unread')">
        {{ getText('Unread', 'ยังไม่ได้อ่าน') }} <span class="filter-count" *ngIf="summary">{{ summary.unread }}</span>
      </button>
      <button class="filter-tab" [class.active]="selectedFilter === 'today'" (click)="changeFilter('today')">
        {{ getText('Today', 'วันนี้') }} <span class="filter-count" *ngIf="summary">{{ summary.today }}</span>
      </button>
    </div>

    <div class="notification-type-filter" *ngIf="hasNotifications()">
      <select class="form-select form-select-sm" [(ngModel)]="selectedType" (change)="changeTypeFilter(selectedType)">
        <option value="all">{{ getText('All Types', 'ทุกประเภท') }}</option>
        <option [value]="NotificationType.NEW_TICKET">{{ getNotificationTypeLabel(NotificationType.NEW_TICKET) }}</option>
        <option [value]="NotificationType.STATUS_CHANGE">{{ getNotificationTypeLabel(NotificationType.STATUS_CHANGE) }}</option>
        <option [value]="NotificationType.ASSIGNMENT">{{ getNotificationTypeLabel(NotificationType.ASSIGNMENT) }}</option>
      </select>
    </div>

    <div class="notification-loading" *ngIf="isLoading">
      <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
      <span class="ms-2">{{ getText('Loading...', 'กำลังโหลด...') }}</span>
    </div>

    <div class="notification-error" *ngIf="errorMessage && !isLoading">
      <i class="bi bi-exclamation-triangle-fill text-warning"></i>
      <span class="error-message">{{ errorMessage }}</span>
      <div class="error-actions">
        <button class="btn btn-sm btn-outline-primary" (click)="refreshNotifications()">
          <i class="bi bi-arrow-clockwise"></i> {{ getText('Retry', 'ลองใหม่') }}
        </button>
      </div>
    </div>

    <div class="notification-list" *ngIf="!isLoading && !errorMessage">
      
      <div class="notification-empty" *ngIf="getFilteredNotifications().length === 0">
        <i class="bi bi-bell-slash empty-icon"></i>
        <p class="empty-text">{{ getText('No notifications', 'ไม่มีการแจ้งเตือน') }}</p>
      </div>

      <div *ngFor="let notification of getFilteredNotifications(); trackBy: trackByNotificationId"
        class="notification-item"
        [class.unread]="notification.status === NotificationStatus.UNREAD"
        [class.high-priority]="notification.priority === NotificationPriority.HIGH || notification.priority === NotificationPriority.URGENT"
        (click)="onNotificationClick(notification, $event)">
        
        <div class="notification-icon" [style.background-color]="notification.color">
          <i class="bi" [ngClass]="notification.icon"></i>
        </div>

        <div class="notification-content">
          <div class="notification-title-row">
            <h6 class="notification-title">{{ notification.title }}</h6>
            <span *ngIf="notification.priority === NotificationPriority.HIGH || notification.priority === NotificationPriority.URGENT"
              class="badge badge-sm" [ngClass]="getPriorityBadgeClass(notification.priority)">
              {{ getNotificationPriorityLabel(notification.priority) }}
            </span>
          </div>

          <p class="notification-message">{{ truncateText(notification.message, 80) }}</p>

          <div class="notification-meta">
            <span class="meta-item"><i class="bi bi-clock"></i> {{ notification.timeAgo }}</span>
            <span class="meta-item"><i class="bi bi-tag"></i> {{ notification.ticket_no }}</span>
          </div>
        </div>

        <div class="notification-actions">
          <button *ngIf="notification.status === NotificationStatus.UNREAD" class="btn-icon-tiny" (click)="markAsRead(notification, $event)">
            <i class="bi bi-check"></i>
          </button>
          <button class="btn-icon-tiny btn-delete" (click)="deleteNotification(notification, $event)">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="notification-footer" *ngIf="hasNotifications() && !isLoading">
      <button class="btn btn-link btn-sm w-100" (click)="viewAllNotifications($event)">
        {{ getText('View All Notifications', 'ดูการแจ้งเตือนทั้งหมด') }}
      </button>
      <button class="btn btn-link btn-sm text-danger w-100" (click)="deleteAllNotifications($event)">
        <i class="bi bi-trash"></i> {{ getText('Clear All', 'ลบทั้งหมด') }}
      </button>
    </div>

  </div>
  <div class="notification-backdrop" [class.show]="isDropdownOpen" (click)="closeDropdown()"></div>
</div>